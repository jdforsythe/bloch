"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const WebSocket = require("ws");
/**
 * Takes in config containing controllers for handling
 * inbound requests; returns object with methods for
 * sending outbound requests
 */
exports.listen = (cfg) => {
    const server = new WebSocket.Server({ port: cfg.port });
    const peerSockets = [];
    let messageHandler;
    const newPeersFn = (newPeers) => {
        if (peerSockets.length >= cfg.maxPeers) {
            return;
        }
        const connectedPeerUrls = peerSockets.map((ws) => ws.url);
        const newUrls = newPeers.filter((url) => !connectedPeerUrls.includes(url));
        newUrls.forEach((url) => {
            const peerSocket = new WebSocket(`ws://${url}`);
            peerSocket.on('open', () => {
                peerSocket.on('message', messageHandler);
                sendChain(peerSocket, cfg.chain);
            });
            peerSocket.on('error', (err) => {
                // tslint:disable-next-line no-any
                if (err.code === 'ECONNREFUSED') {
                    console.log('Failed to connect to peer');
                    setTimeout(() => newPeersFn([url]), 5000);
                }
            });
            peerSockets.push(peerSocket);
        });
    };
    messageHandler = getMessageHandler(cfg, newPeersFn);
    // when a peer connects inbound
    server.on('connection', (ws) => {
        ws.on('message', messageHandler);
        sendChain(ws, cfg.chain);
        broadcastMessage([ws], { data: peerSockets.map((s) => s.url), type: "peers" /* peers */ });
        peerSockets.push(ws);
    });
    // connect to known peers on startup
    newPeersFn(cfg.knownPeers);
    // return the outbound API
    return {
        broadcastTransaction(data) {
            broadcastMessage(peerSockets, { data, type: "transaction" /* transaction */ });
        },
        broadcastChain() {
            const { chain: data } = cfg;
            broadcastMessage(peerSockets, { data, type: "chain" /* chain */ });
        },
    };
};
function broadcastMessage(peers, msg) {
    const serialized = JSON.stringify(msg);
    peers.forEach((ws) => {
        ws.send(serialized);
    });
}
function getMessageHandler(cfg, newPeersCallback) {
    return (msg) => {
        const p2pMessage = JSON.parse(msg.toString());
        switch (p2pMessage.type) {
            case "chain" /* chain */: {
                return cfg.controllers.newChain(p2pMessage.data);
            }
            case "transaction" /* transaction */: {
                return cfg.controllers.newTransaction(p2pMessage.data);
            }
            case "peers" /* peers */: {
                return newPeersCallback(p2pMessage.data);
            }
            default: {
                return;
            }
        }
    };
}
function sendChain(ws, chain) {
    ws.send(JSON.stringify({ data: chain, type: "chain" /* chain */ }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3AycC1zZXJ2ZXIvc2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsZ0NBQWdDO0FBOEJoQzs7OztHQUlHO0FBQ1UsUUFBQSxNQUFNLEdBQUcsQ0FBQyxHQUFpQixFQUEwQixFQUFFO0lBQ2xFLE1BQU0sTUFBTSxHQUFHLElBQUksU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUN4RCxNQUFNLFdBQVcsR0FBZ0IsRUFBRSxDQUFDO0lBQ3BDLElBQUksY0FBOEIsQ0FBQztJQUVuQyxNQUFNLFVBQVUsR0FBRyxDQUFDLFFBQWtCLEVBQUUsRUFBRTtRQUN4QyxJQUFJLFdBQVcsQ0FBQyxNQUFNLElBQUksR0FBRyxDQUFDLFFBQVEsRUFBRTtZQUN0QyxPQUFPO1NBQ1I7UUFFRCxNQUFNLGlCQUFpQixHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMxRCxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRTNFLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUN0QixNQUFNLFVBQVUsR0FBRyxJQUFJLFNBQVMsQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFFaEQsVUFBVSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFO2dCQUN6QixVQUFVLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxjQUFjLENBQUMsQ0FBQztnQkFFekMsU0FBUyxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLENB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QUVELE9BQU8sQ0FBQyxDQUFDO2dCQUNQLE9BQU87YUFDUjtTQUNGO0lBQ0gsQ0FBQyxDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsU0FBUyxDQUFDLEVBQWEsRUFBRSxLQUFpQjtJQUNqRCxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUkscUJBQW1CLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDcEUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFdlYlNvY2tldCBmcm9tICd3cyc7XG5cbmltcG9ydCB7IE1lc3NhZ2VUeXBlLCBQMlBNZXNzYWdlIH0gZnJvbSAnLi9tZXNzYWdlcy5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQmxvY2tjaGFpbiwgU2lnbmVkVHJhbnNhY3Rpb24gfSBmcm9tICcuLi9jaGFpbi9pbnRlcmZhY2UnO1xuXG4vKipcbiAqIFNlcnZlciBjb25maWd1cmF0aW9uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU2VydmVyQ29uZmlnIHtcbiAgY2hhaW46IEJsb2NrY2hhaW47XG4gIHBvcnQ6IG51bWJlcjtcbiAga25vd25QZWVyczogc3RyaW5nW107XG4gIG1heFBlZXJzOiBudW1iZXI7XG4gIGNvbnRyb2xsZXJzOiB7XG4gICAgbmV3Q2hhaW4obXNnOiBCbG9ja2NoYWluKTogdm9pZDtcbiAgICBuZXdUcmFuc2FjdGlvbihtc2c6IFNpZ25lZFRyYW5zYWN0aW9uKTogdm9pZDtcbiAgfTtcbn1cblxuLyoqXG4gKiBCcm9hZGNhc3QgbWV0aG9kcyBvbiB0aGUgc2VydmVyXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU2VydmVyQnJvYWRjYXN0TWV0aG9kcyB7XG4gIGJyb2FkY2FzdFRyYW5zYWN0aW9uKHQ6IFNpZ25lZFRyYW5zYWN0aW9uKTogdm9pZDtcbiAgYnJvYWRjYXN0Q2hhaW4oKTogdm9pZDtcbn1cblxudHlwZSBOZXdQZWVyc0Z1bmN0aW9uID0gKHBlZXJVcmxzOiBzdHJpbmdbXSkgPT4gdm9pZDtcbnR5cGUgTWVzc2FnZUhhbmRsZXIgPSAobXNnOiBzdHJpbmcpID0+IHZvaWQ7XG5cbi8qKlxuICogVGFrZXMgaW4gY29uZmlnIGNvbnRhaW5pbmcgY29udHJvbGxlcnMgZm9yIGhhbmRsaW5nXG4gKiBpbmJvdW5kIHJlcXVlc3RzOyByZXR1cm5zIG9iamVjdCB3aXRoIG1ldGhvZHMgZm9yXG4gKiBzZW5kaW5nIG91dGJvdW5kIHJlcXVlc3RzXG4gKi9cbmV4cG9ydCBjb25zdCBsaXN0ZW4gPSAoY2ZnOiBTZXJ2ZXJDb25maWcpOiBTZXJ2ZXJCcm9hZGNhc3RNZXRob2RzID0+IHtcbiAgY29uc3Qgc2VydmVyID0gbmV3IFdlYlNvY2tldC5TZXJ2ZXIoeyBwb3J0OiBjZmcucG9ydCB9KTtcbiAgY29uc3QgcGVlclNvY2tldHM6IFdlYlNvY2tldFtdID0gW107XG4gIGxldCBtZXNzYWdlSGFuZGxlcjogTWVzc2FnZUhhbmRsZXI7XG5cbiAgY29uc3QgbmV3UGVlcnNGbiA9IChuZXdQZWVyczogc3RyaW5nW10pID0+IHtcbiAgICBpZiAocGVlclNvY2tldHMubGVuZ3RoID49IGNmZy5tYXhQZWVycykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbm5lY3RlZFBlZXJVcmxzID0gcGVlclNvY2tldHMubWFwKCh3cykgPT4gd3MudXJsKTtcbiAgICBjb25zdCBuZXdVcmxzID0gbmV3UGVlcnMuZmlsdGVyKCh1cmwpID0+ICFjb25uZWN0ZWRQZWVyVXJscy5pbmNsdWRlcyh1cmwpKTtcblxuICAgIG5ld1VybHMuZm9yRWFjaCgodXJsKSA9PiB7XG4gICAgICBjb25zdCBwZWVyU29ja2V0ID0gbmV3IFdlYlNvY2tldChgd3M6Ly8ke3VybH1gKTtcblxuICAgICAgcGVlclNvY2tldC5vbignb3BlbicsICgpID0+IHtcbiAgICAgICAgcGVlclNvY2tldC5vbignbWVzc2FnZScsIG1lc3NhZ2VIYW5kbGVyKTtcblxuICAgICAgICBzZW5kQ2hhaW4ocGVlclNvY2tldCwgY2ZnLmNoYWluKTtcbiAgICAgIH0pO1xuXG4gICAgICBwZWVyU29ja2V0Lm9uKCdlcnJvcicsIChlcnI6IEVycm9yKSA9PiB7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZSBuby1hbnlcbiAgICAgICAgaWYgKCg8YW55PiBlcnIpLmNvZGUgID09PSAnRUNPTk5SRUZVU0VEJykge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdGYWlsZWQgdG8gY29ubmVjdCB0byBwZWVyJyk7XG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBuZXdQZWVyc0ZuKFt1cmxdKSwgNTAwMCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICBwZWVyU29ja2V0cy5wdXNoKHBlZXJTb2NrZXQpO1xuICAgIH0pO1xuICB9O1xuXG4gIG1lc3NhZ2VIYW5kbGVyID0gZ2V0TWVzc2FnZUhhbmRsZXIoY2ZnLCBuZXdQZWVyc0ZuKTtcblxuICAvLyB3aGVuIGEgcGVlciBjb25uZWN0cyBpbmJvdW5kXG4gIHNlcnZlci5vbignY29ubmVjdGlvbicsICh3czogV2ViU29ja2V0KSA9PiB7XG4gICAgd3Mub24oJ21lc3NhZ2UnLCBtZXNzYWdlSGFuZGxlcik7XG5cbiAgICBzZW5kQ2hhaW4od3MsIGNmZy5jaGFpbik7XG5cbiAgICBicm9hZGNhc3RNZXNzYWdlKFt3c10sIHsgZGF0YTogcGVlclNvY2tldHMubWFwKChzKSA9PiBzLnVybCksIHR5cGU6IE1lc3NhZ2VUeXBlLnBlZXJzIH0pO1xuXG4gICAgcGVlclNvY2tldHMucHVzaCh3cyk7XG4gIH0pO1xuXG4gIC8vIGNvbm5lY3QgdG8ga25vd24gcGVlcnMgb24gc3RhcnR1cFxuICBuZXdQZWVyc0ZuKGNmZy5rbm93blBlZXJzKTtcblxuICAvLyByZXR1cm4gdGhlIG91dGJvdW5kIEFQSVxuICByZXR1cm4ge1xuICAgIGJyb2FkY2FzdFRyYW5zYWN0aW9uKGRhdGE6IFNpZ25lZFRyYW5zYWN0aW9uKSB7XG4gICAgICBicm9hZGNhc3RNZXNzYWdlKHBlZXJTb2NrZXRzLCB7IGRhdGEsIHR5cGU6IE1lc3NhZ2VUeXBlLnRyYW5zYWN0aW9uIH0pO1xuICAgIH0sXG5cbiAgICBicm9hZGNhc3RDaGFpbigpIHtcbiAgICAgIGNvbnN0IHsgY2hhaW46IGRhdGEgfSA9IGNmZztcbiAgICAgIGJyb2FkY2FzdE1lc3NhZ2UocGVlclNvY2tldHMsIHsgZGF0YSwgdHlwZTogTWVzc2FnZVR5cGUuY2hhaW4gfSk7XG4gICAgfSxcbiAgfTtcbn07XG5cbmZ1bmN0aW9uIGJyb2FkY2FzdE1lc3NhZ2UocGVlcnM6IFdlYlNvY2tldFtdLCBtc2c6IFAyUE1lc3NhZ2UpIHtcbiAgY29uc3Qgc2VyaWFsaXplZCA9IEpTT04uc3RyaW5naWZ5KG1zZyk7XG5cbiAgcGVlcnMuZm9yRWFjaCgod3M6IFdlYlNvY2tldCkgPT4ge1xuICAgIHdzLnNlbmQoc2VyaWFsaXplZCk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBnZXRNZXNzYWdlSGFuZGxlcihjZmc6IFNlcnZlckNvbmZpZywgbmV3UGVlcnNDYWxsYmFjazogTmV3UGVlcnNGdW5jdGlvbik6IE1lc3NhZ2VIYW5kbGVyIHtcbiAgcmV0dXJuIChtc2c6IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IHAycE1lc3NhZ2U6IFAyUE1lc3NhZ2UgPSBKU09OLnBhcnNlKG1zZy50b1N0cmluZygpKTtcblxuICAgIHN3aXRjaCAocDJwTWVzc2FnZS50eXBlKSB7XG4gICAgICBjYXNlIE1lc3NhZ2VUeXBlLmNoYWluOiB7XG4gICAgICAgIHJldHVybiBjZmcuY29udHJvbGxlcnMubmV3Q2hhaW4ocDJwTWVzc2FnZS5kYXRhKTtcbiAgICAgIH1cblxuICAgICAgY2FzZSBNZXNzYWdlVHlwZS50cmFuc2FjdGlvbjoge1xuICAgICAgICByZXR1cm4gY2ZnLmNvbnRyb2xsZXJzLm5ld1RyYW5zYWN0aW9uKHAycE1lc3NhZ2UuZGF0YSk7XG4gICAgICB9XG5cbiAgICAgIGNhc2UgTWVzc2FnZVR5cGUucGVlcnM6IHtcbiAgICAgICAgcmV0dXJuIG5ld1BlZXJzQ2FsbGJhY2socDJwTWVzc2FnZS5kYXRhKTtcbiAgICAgIH1cblxuICAgICAgZGVmYXVsdDoge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICB9O1xufVxuXG5mdW5jdGlvbiBzZW5kQ2hhaW4od3M6IFdlYlNvY2tldCwgY2hhaW46IEJsb2NrY2hhaW4pIHtcbiAgd3Muc2VuZChKU09OLnN0cmluZ2lmeSh7IGRhdGE6IGNoYWluLCB0eXBlOiBNZXNzYWdlVHlwZS5jaGFpbiB9KSk7XG59XG4iXX0=